<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name='description' content='朱海保的个人网站'>
    <meta name='keywords' content='java, spring, javascript, html, css, mariadb, jpa'>
    <title>aspectj如何操作 - SpringBoot</title>
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/js/lib/prism/prism.css">
    <script src="/js/lib/prism/prism.js"></script>
    <script src="/js/base.js"></script>
    <script src="/js/lib/flexsearch/flexsearch.bundle.min.js"></script>
    <link rel="stylesheet" href="/css/base.css"/>
    <link rel="stylesheet" href="/css/articles.css"/>
    <link rel="stylesheet" href="/css/devices.css"/>

</head>

<body>
<div class="topDiv">
    <div class="topBar">
        <div class="logoDiv">
            <a href="/index.html">
                <img src="/img/logo.svg">
            </a>
        </div>
        <div class="searchDiv">
            <input type="text" name="searchKey" id="searchInput" placeholder="搜索文章...">
            <img class="searchImg" src="/img/searchicon.svg" id="searchButton">
        </div>
        <div class="userInfoDiv">
            <span></span>
        </div>
    </div>
    <div class="navBar">
        <div class="arrow" id="leftArrow"></div>
        <i id="treeBar" class="fa fa-bars treeBar" onclick="treeBarFun();"></i>
        <nav>
            <ul id="topNav">
                <li id="articleLabel"><a href="/articles/index.html">点滴文章</a></li>
                <li><a href='/subject/springboot/index.html'>SpringBoot</a></li>
<li><a href='/subject/java/index.html'>Java</a></li>
<li><a href='/subject/html/index.html'>html</a></li>
<li><a href='/subject/search-engine/index.html'>搜索引擎</a></li>
<li><a href='/subject/css/index.html'>CSS</a></li>

            </ul>
        </nav>
        <div class="arrow" id="rightArrow"></div>
    </div>
</div>
<div class="mainDiv">
    <div class="titleTreeDiv700 titleTreeDiv" id="titleTreeDiv">
        <p class='subjectTitle' data-sub-dir='springboot'>SpringBoot</p>
        <hr>
        <nav class="titleTree" id="titleTree"><a href='/subject/springboot/springframework/index.html'>Spring Framework</a>
<a href='/subject/springboot/springdata/index.html'>Spring Data</a>
<div><a href='/subject/springboot/springjpa/index.html'>Spring Data JPA</a>
<a href='/subject/springboot/springjdbc/index.html'>Spring Data JDBC</a>
<a href='/subject/springboot/mongo/index.html'>Spring mongo</a>
<a href='/subject/springboot/spring-redis/index.html'>Spring Redis</a>
</div>
<a href='/subject/springboot/springcloud/index.html'>Spring Cloud</a>
<div><a href='/subject/springboot/gatewaay/index.html'>Spring 网关</a>
</div>
<a href='/subject/springboot/security/index.html'>Spring Security</a>
<div><a href='/subject/springboot/springsecurity/index.html'>Spring Security Kerberos</a>
</div>
<a href='/subject/springboot/aspectj/index.html'>aspectj如何操作</a>
</nav>
    </div>
    <div class="contentDiv">
        <section>
            <header>
                <span class='articleTitle' id='articleTitle'>aspectj如何操作</span>
                <span class='publishTime'>lastUpdated : 2024-11-04 04:01:10</span>
            </header>
            <section title="author" class="author">
                <img id="authorLogo" src="/img/subject-logo4.svg">
                <a class="authorName zcool-xiaowei-regular" href="https://twitter.com/jumperoverfgw">朱海保</a>
                <a href="https://github.com/zhuhaibao"><img class="siteImg" src="/img/github.svg"></a>
                <a href="https://twitter.com/jumperoverfgw"><img class="siteImg" src="/img/X.svg"></a>
                <span class='zcool-xiaowei-regular'>自由职业 专业开发 10年it魔域经验</span>
            </section>
            <article id='articleContent'><p><br></p><pre class="language-java">package com.jumper.jit.aspect;

import com.jumper.jit.dto.SubjectDTO;
import com.jumper.jit.model.Article;
import com.jumper.jit.model.Subject;
import com.jumper.jit.service.ArticleService;
import com.jumper.jit.service.DeployService;
import com.jumper.jit.service.SubjectService;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.junit.jupiter.api.Order;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Aspect
@Component
@Order(1)
@Slf4j
public class AutoDeployProcessor {

    private DeployService deployService;
    private ArticleService articleService;
    private SubjectService subjectService;

    @Autowired
    public void setDeployService(DeployService deployService) {
        this.deployService = deployService;
    }

    @Autowired
    public void setArticleService(ArticleService articleService) {
        this.articleService = articleService;
    }

    @Autowired
    public void setSubjectService(SubjectService subjectService) {
        this.subjectService = subjectService;
    }

    @Pointcut("execution(* com.jumper.jit.service.impl.DeployServiceImpl.saveAndUpdateSubjectArticleStatus(..))||" +
            "execution(* com.jumper.jit.service.impl.DeployServiceImpl.saveAndUpdateSingleStatus(..))")
    private void saveAndUpdateArticleStatus() {
    }

    @Pointcut("execution(* com.jumper.jit.service.impl.SubjectServiceImpl.moveTo(..))||" +
            "execution(* com.jumper.jit.service.impl.SubjectServiceImpl.deleteNavigation(..))||" +
            "execution(* com.jumper.jit.service.impl.SubjectServiceImpl.addNavigation(..))")
    private void updateNavigation() {
    }

    @Pointcut("execution(* com.jumper.jit.service.impl.SubjectServiceImpl.updateSubject(..))")
    private void updateSubject() {
    }

    @Pointcut("execution(* com.jumper.jit.service.impl.ArticleServiceImpl.delete(..))||" +
            "execution(* com.jumper.jit.service.impl.ArticleServiceImpl.updateTitle(..))||" +
            "execution(* com.jumper.jit.service.impl.ArticleServiceImpl.updateEnName(..))||" +
            "execution(* com.jumper.jit.service.impl.ArticleServiceImpl.moveTo(..))")
    private void updateArticle() {
    }

    @Pointcut("execution(* com.jumper.jit.service.impl.ArticleServiceImpl.insertNodeAsChild(..))")
    private void insertNodeAsChild() {
    }


    @After("saveAndUpdateArticleStatus()")
    public void deployAfterSaveAndUpdateArticleStatus(JoinPoint point) throws Exception {
        MethodSignature signature = (MethodSignature) point.getSignature();
        Article param = (Article) point.getArgs()[0];
        Article dbArticle = articleService.findById(param.getId());
        log.info("{} -&gt;auto deploy current Article[id={},title={}]... ", signature.getName(), param.getId(), param.getTitle());
        if (dbArticle.getSid() != null) {
            deployService.deployCurrentSubjectArticle(param.getId());
        } else {
            deployService.deployCurrentSingle(param.getId());
        }
    }


    @After("updateNavigation()")
    public void autoDeployTopNav(JoinPoint point) throws Exception {
        MethodSignature signature = (MethodSignature) point.getSignature();
        //发布主页index
        log.info("{} -&gt; auto deploy index.html... ", signature.getName());
        deployService.deployIndex();
    }


    @After("updateSubject()")
    public void autoDeploySubject(JoinPoint point) throws Exception {
        MethodSignature signature = (MethodSignature) point.getSignature();
        //发布主页index
        log.info("{} -&gt; auto deploy index.html...  ", signature.getName());
        deployService.deployIndex();
        //如果修改了enName,也就是主题存放目录,那么整个主题要重发一遍
        SubjectDTO subject = (SubjectDTO) point.getArgs()[0];
        Subject dbSubject = subjectService.findById(subject.getId());
        if (subject.getEnName() != null) {
            log.info("{}: enName changed[{}] -&gt; auto deploy AllSubject[{}]... ", signature.getName(), subject.getEnName(), dbSubject.getSubjectTitle());
            deployService.deployAllSubjectArticle(subject.getId());
        }
    }


    @After("updateArticle()")
    public void autoDeploySubjectCauseOfArticleModified(JoinPoint point) throws Exception {
        MethodSignature signature = (MethodSignature) point.getSignature();
        //获取第一个参数id,检查文章状态
        Integer id = (Integer) point.getArgs()[0];
        Article article = articleService.findById(id);
        if (article.getStatus().equals(Article.Status.PUBLISHED.getCode())) {
            if (article.getSid() != null) {
                log.info("{}: -&gt;Article[{}] auto deploy AllSubject[{}]... ", id, signature.getName(), article.getSubject().getSubjectTitle());
                deployService.deployAllSubjectArticle(article.getSubject().getId());
            } else {
                log.info("{}: -&gt;Article[{}]  auto deploy deployAllSingleArticle... ", id, signature.getName());
                deployService.deployAllSingleArticle();
            }
        }
    }


    @Around("insertNodeAsChild()")
    public Object autoDeployAfterInsertNode(ProceedingJoinPoint point) throws Throwable {
        Integer articleId = (Integer) point.getArgs()[0];
        Integer targetId = (Integer) point.getArgs()[1];
        boolean isSubject = (boolean) point.getArgs()[2];
        Article article = articleService.findById(articleId);//执行前获取参数
        Object object = point.proceed(point.getArgs());//执行
        //非发布状态直接返回
        if (article.getStatus().compareTo(Article.Status.PUBLISHED.getCode()) &lt; 0) return object;
        //有所属主题则重新发布该主题,否则重新发布单体文章列表
        if (article.getSid() != null) {
            deployService.deployAllSubjectArticle(article.getSid());
        } else {
            deployService.deployAllSingleArticle();
        }
        //获取移动目标的主题
        Integer targetSid;
        if (isSubject) {
            targetSid = targetId;
        } else {
            Article target = articleService.findById(targetId);
            targetSid = target.getSid();
        }
        //如果主题不同,则重发布目标主题
        if (!targetSid.equals(article.getSid())) {
            deployService.deployAllSubjectArticle(targetSid);
        }
        return object;
    }
}</pre></article>
        </section>
    </div>
</div>
<!--显示搜索结果-->
<div id="searchResultDiv">
    <div id="searchResult"></div>
    <hr>
    <a class="siteSearch" href="javascript:void(0);" id="showSearchAll">显示全部</a>
</div>
<!--模态窗口div,显示google结果-->
<div class="modal" id="modalResult" onclick="if(event.target==modalResult)modalResult.style.display='none'">
    <div class="modalContent">
        <div class="modalBody">
            <div class="searchTitle">
                <span class="close" id='close' onclick="modalResult.style.display='none'">&times;</span>
                <span class="resultAnalysis" id="resultAnalysis"></span><br>
                <hr class="hrsplit">
            </div>
            <div id="searchResultAll"></div>
            <div class="page">
                <button class="pageButton" id="pagePrev">上一页</button>
                <div class="pageIndex"></div>
                <button class="pageButton" id="pageNext">下一页</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    loadNav();
</script>
<script src="/js/articleTree.js"></script>
<script type="module" src="/js/indexSearch.js"></script>
</body>

</html>